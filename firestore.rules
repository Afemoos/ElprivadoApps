rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Reglas para Spotify App (y otras apps compartidas)
    match /artifacts/{appId}/public/data/{document=**} {
      allow read: if true;
      allow write: if request.auth != null;
    }

    // Reglas para Invites (Códigos de acceso)
    match /invites/{code} {
      allow read: if true;
      allow write: if request.auth != null;
    }

    // Reglas para Grupos (Multi-Tenant)
    match /groups/{groupId} {
      // PERMISO ESPECIAL PARA DARWIN (MIGRACIÓN)
      allow read, write: if request.auth.token.email == 'darwin47@elprivado.app';
      
      // Allow migration for the legacy group specifically
      // IMPORTANTE: Esto permite que la herramienta de migración funcione
      allow read, write: if groupId == 'darwin-legacy' && request.auth != null;

      // Leer: 
      // 1. Dueño
      // 2. Miembro (en memberUids)
      // 3. Cualquiera que conozca el ID (para visitantes con código) -> Permitimos GET
      allow get: if true; 
      
      allow list: if request.auth != null && (
        resource.data.ownerId == request.auth.uid ||
        resource.data.memberUids.hasAny([request.auth.uid])
      );

      // Crear grupo: Cualquiera autenticado
      allow create: if request.auth != null;
      
      // Actualizar: Dueño, Miembros (limitado), o unirse (modificar memberUids)
      allow update: if request.auth != null && (
        resource.data.ownerId == request.auth.uid ||
        resource.data.memberUids.hasAny([request.auth.uid]) ||
        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['memberUids'])
      );
      
      allow delete: if request.auth != null && resource.data.ownerId == request.auth.uid;

      match /members/{memberId} {
         allow read: if true; 
         allow write: if request.auth != null;
      }
      
      match /payments/{paymentId} {
         allow read: if true;
         allow write: if request.auth != null;
      }

      match /requests/{requestId} {
         allow read: if true;
         allow write: if request.auth != null;
      }
    }

    // Reglas para Rutinas de Gym
    match /gym_routines/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }

    // --- REGLAS PARA RECOCHO (APP 3) ---
    // Acceso público total para crear y unirse sin cuenta
    match /recochos/{gameId} {
      allow read, write: if true;
    }
    
    // Bloquear todo lo demás por defecto
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
